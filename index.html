<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SmsRental</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0f1115;color:#e6e6e6;font:16px/1.4 system-ui,Arial}
    .wrap{padding:18px}
    h1{font-size:20px;margin:0 0 16px}
    .err{color:#ff5c5c;white-space:pre-wrap}
    .card{background:#161a22;border:1px solid #222834;border-radius:12px;padding:12px;margin:8px 0}
    .name{font-weight:600}
    .price{opacity:.9}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Select service</h1>
  <div id="list"></div>
  <div id="error" class="err" style="display:none"></div>
</div>

<script>
(async function(){
  const $list = document.getElementById('list');
  const $err  = document.getElementById('error');

  function showErr(msg){ $err.style.display='block'; $err.textContent='Failed to load\n'+msg; }

  // 1) беремо базу API з ?api=...
  const p = new URLSearchParams(location.search);
  const API = (p.get('api') || '').replace(/\/+$/,''); // без слеша в кінці
  if (!API) return showErr("Missing ?api=https://api.example.com");

  try {
    const resp = await fetch(API + '/api/wa/services', {
      method:'GET',
      // без cookies — простіший CORS
      credentials:'omit',
      headers: {
        // за бажанням можна передати initData для бекенд-валідації
        // 'X-Tg-Init-Data': window.Telegram?.WebApp?.initData || ''
      }
    });
    if(!resp.ok){
      const txt = await resp.text().catch(()=> '');
      throw new Error(`${resp.status} ${resp.statusText}${txt?'\n'+txt:''}`);
    }
    const data = await resp.json();
    const items = data.items || [];
    if(items.length === 0){ $list.textContent='No services yet'; return; }

    items.forEach(s => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML =
        `<div class="name">${s.icon??''} ${s.name}
           <span class="price">— ${s.pricingMode} • ${s.price}$</span>
         </div>`;
      $list.appendChild(div);
    });
  } catch(e){ showErr(e.message); console.error(e); }
})();
</script>
</body>
</html>
